cat > .htaccess << 'EOF'
# Traffic Analytics .htaccess for Kali Linux

# Security headers
Header set X-Frame-Options "SAMEORIGIN"
Header set X-Content-Type-Options "nosniff"
Header set X-XSS-Protection "1; mode=block"
Header set Referrer-Policy "strict-origin-when-cross-origin"
Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Disable directory listing
Options -Indexes

# Prevent access to sensitive files
<FilesMatch "^(config|database)\.php$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

<FilesMatch "\.(sql|log|txt|md)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# URL rewriting
RewriteEngine On
RewriteBase /

# API endpoints
RewriteRule ^api/track/([a-zA-Z0-9_-]+)/?$ track.php?site_id=$1 [QSA,L]
RewriteRule ^api/stats/([a-zA-Z0-9_-]+)/?$ api.php?action=stats&site_id=$1 [QSA,L]

# Redirect to login if not authenticated
RewriteCond %{REQUEST_URI} ^/admin\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{HTTP_COOKIE} !admin_logged_in=1
RewriteRule ^admin\.php$ login.php?redirect=admin [L,R]

# Block common exploits
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|[|%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|[|%[0-9A-Z]{0,2})
RewriteRule ^(.*)$ - [F,L]

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript
</IfModule>

# Cache control
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
</IfModule>

# Custom error pages
ErrorDocument 404 /error/404.html
ErrorDocument 403 /error/403.html
ErrorDocument 500 /error/500.html

# Prevent access to .git directory
RedirectMatch 404 /\.git

# Enable CORS for track.php
<Files "track.php">
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type"
</Files>
EOF